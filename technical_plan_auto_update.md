# DeskCare 在线自动更新技术方案 (Auto-Update Technical Proposal)

## 1. 方案概述 (Overview)

本方案旨在为 **DeskCare** 增加基于 HTTP 的自动检查与更新功能。
**核心原则**：**低打扰 (Non-intrusive)**。
当检测到新版本时，**不主动弹出窗口或通知**，而是通过主界面图标的视觉特效（如闪烁）提示用户。用户主动点击后才进行交互。更新过程采用**独立更新程序 (Updater)** 模式实现无缝覆盖安装。

## 2. 架构设计 (Architecture)

### 2.1 服务端 (Server Side)
- **基础设施**：现有阿里云服务器 (Nginx)。
- **资源路径**：`/var/www/deskcare/updates/`
- **文件清单**：
  - `version.json`：版本控制文件。
  - `DeskCare_vX.X.X.zip`：各版本安装包。

### 2.2 客户端 (Client Side)
客户端包含两部分：
1.  **DeskCare 主程序**：负责静默检查、视觉提示、下载文件、进度展示。
2.  **Updater 工具 (独立 EXE)**：负责文件覆盖和重启。

## 3. 详细交互流程 (Workflow) - **核心修改点**

### 3.1 阶段一：静默检查与视觉提示 (Silent Check & Visual Cue)
1.  **触发**：软件启动时自动在后台检查更新。
2.  **无更新**：无任何界面变化，用户无感知。
3.  **有更新**：
    - **不弹窗**。
    - 主设置界面的 **“刷新/更新图标”** 开始执行 **轻微闪烁/呼吸动画** (Opacity/Color Animation)。
    - 鼠标悬停在图标上时，显示 Tooltip：“发现新版本 v1.1.0”。

### 3.2 阶段二：用户主动触发 (User Interaction)
用户点击“刷新/更新图标”时，根据当前状态进行响应：

#### 情况 A：无新版本 (No Update)
- **动作**：显示 Toast 提示（与“间隔时间”提示风格一致）。
- **内容**：“当前已是最新版本”。

#### 情况 B：有新版本 (Update Available)
- **动作**：弹出模态确认对话框 (Custom Dialog)。
- **风格**：与主界面 UI 风格统一（半透明、圆角、科技感）。
- **内容**：
  - 标题：“发现新版本 v1.1.0”
  - 内容：更新日志 (Changelog)
  - 按钮：【立即更新】 【稍后再说】

### 3.3 阶段三：下载与进度 (Download & Progress)
1.  **开始下载**：用户点击【立即更新】后，对话框关闭。
2.  **进度展示**：
    - 在主界面显示下载进度条（可复用倒计时圆环或在底部新增进度条）。
    - 状态栏显示：“正在下载更新... 45%”
3.  **下载完成**：
    - 校验文件 Hash（可选）。
    - 准备启动 Updater。

### 3.4 阶段四：覆盖安装 (Install)
1.  **退出主程序**：下载完成后，主程序启动 `Updater.exe` 并传入参数，随即自我退出。
2.  **执行更新**：
    - `Updater.exe` (无边框小窗口) 显示：“正在安装更新...”。
    - 等待主进程结束。
    - 解压 ZIP 包覆盖安装目录。
3.  **重启**：更新完成后，自动重新启动 `DeskCare.exe`。

## 4. UI/UX 规范
- **图标闪烁**：使用 Opacity 动画，范围 0.6 - 1.0，周期 2秒，避免过于刺眼。
- **Toast 提示**：复用现有的 `Toast` 组件，右下角弹出，3秒自动消失。
- **确认弹窗**：使用 `Popup` 组件自定义，背景模糊 (Glassmorphism)，按钮悬停有高亮效果。
- **进度条**：科技蓝 (`#00d2ff`)，细条状，或利用现有的圆环进度条变为下载进度模式。

## 5. 开发计划 (Development Plan)

1.  **服务端**：部署 `version.json` 和测试 ZIP 包。
2.  **Updater 工具**：开发独立的 Qt 极简更新器。
3.  **主程序改造**：
    - 集成 `UpdateManager` (网络请求)。
    - **UI 实现**：
        - 添加 `UpdateIcon` (刷新图标)。
        - 实现 `onHasUpdateChanged` 时的闪烁动画。
        - 实现点击逻辑 (Toast vs Dialog)。
        - 实现下载进度 UI。
4.  **联调测试**：验证“静默发现 -> 闪烁 -> 点击 -> 确认 -> 更新”全流程。
